{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>Add Event</h5>
            </div>
            <div class="card-body">
                <form id="event-form">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="event-title" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="event-start-date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="event-start-time" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="event-end-date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-control" id="event-end-time">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="event-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="event-recurring">
                        <label class="form-check-label" for="event-recurring">Recurring Event</label>
                    </div>
                    <div class="mb-3" id="recurrence-options" style="display: none;">
                        <label class="form-label">Recurrence Pattern</label>
                        <select class="form-select" id="event-recurrence-pattern">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Event</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5>Add Task</h5>
            </div>
            <div class="card-body">
                <form id="task-form">
                    <div class="mb-3">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="task-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="task-due-date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="task-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="task-description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calendar & Events</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-light" id="view-events">Events</button>
                    <button class="btn btn-sm btn-outline-light" id="view-tasks">Tasks</button>
                </div>
            </div>
            <div class="card-body">
                <div id="calendar-view">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let deleteItemType, deleteItemId;
    let currentView = 'events'; // 'events' or 'tasks'
    
    // Set default dates and times
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const timeNow = now.toTimeString().substring(0, 5);
    const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000).toTimeString().substring(0, 5);
    
    document.getElementById('event-start-date').value = today;
    document.getElementById('event-start-time').value = timeNow;
    document.getElementById('event-end-date').value = today;
    document.getElementById('event-end-time').value = oneHourLater;
    document.getElementById('task-due-date').value = today;
    
    // Toggle recurrence options
    document.getElementById('event-recurring').addEventListener('change', function() {
        document.getElementById('recurrence-options').style.display = this.checked ? 'block' : 'none';
    });
    
    // View toggle
    document.getElementById('view-events').addEventListener('click', function() {
        if (currentView !== 'events') {
            currentView = 'events';
            this.classList.replace('btn-outline-light', 'btn-light');
            document.getElementById('view-tasks').classList.replace('btn-light', 'btn-outline-light');
            loadEvents();
        }
    });
    
    document.getElementById('view-tasks').addEventListener('click', function() {
        if (currentView !== 'tasks') {
            currentView = 'tasks';
            this.classList.replace('btn-outline-light', 'btn-light');
            document.getElementById('view-events').classList.replace('btn-light', 'btn-outline-light');
            loadTasks();
        }
    });
    
    // Event form submission
    document.getElementById('event-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const startDate = document.getElementById('event-start-date').value;
        const startTime = document.getElementById('event-start-time').value;
        const endDate = document.getElementById('event-end-date').value || startDate;
        const endTime = document.getElementById('event-end-time').value || oneHourLater;
        
        const eventData = {
            title: document.getElementById('event-title').value,
            start: `${startDate}T${startTime}`,
            end: `${endDate}T${endTime}`,
            description: document.getElementById('event-description').value,
            recurring: document.getElementById('event-recurring').checked,
            recurrence_pattern: document.getElementById('event-recurring').checked ? 
                document.getElementById('event-recurrence-pattern').value : null
        };
        
        fetch('/api/add_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Event Added',
                    text: 'Your event has been added successfully!',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Reset form
                document.getElementById('event-form').reset();
                document.getElementById('event-start-date').value = today;
                document.getElementById('event-start-time').value = timeNow;
                document.getElementById('event-end-date').value = today;
                document.getElementById('event-end-time').value = oneHourLater;
                document.getElementById('recurrence-options').style.display = 'none';
                
                // Reload events
                loadEvents();
            } else {
                throw new Error(data.message || 'Failed to add event');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to add event'
            });
        });
    });
    
    // Task form submission
    document.getElementById('task-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const taskData = {
            name: document.getElementById('task-name').value,
            due_date: document.getElementById('task-due-date').value,
            priority: document.getElementById('task-priority').value,
            description: document.getElementById('task-description').value
        };
        
        fetch('/api/add_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Task Added',
                    text: 'Your task has been added successfully!',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Reset form
                document.getElementById('task-form').reset();
                document.getElementById('task-due-date').value = today;
                
                // Reload tasks if we're viewing them
                if (currentView === 'tasks') {
                    loadTasks();
                }
            } else {
                throw new Error(data.message || 'Failed to add task');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to add task'
            });
        });
    });
    
    // Load events
    function loadEvents() {
        fetch('/api/get_events')
            .then(response => response.json())
            .then(events => {
                const container = document.getElementById('calendar-view');
                
                if (Object.keys(events).length === 0) {
                    container.innerHTML = '<p class="text-center py-5">No events scheduled</p>';
                    return;
                }
                
                // Sort events by start date
                const sortedEvents = Object.values(events).sort((a, b) => new Date(a.start) - new Date(b.start));
                
                // Group events by date
                const eventsByDate = {};
                sortedEvents.forEach((event, index) => {
                    const dateKey = new Date(event.start).toLocaleDateString();
                    if (!eventsByDate[dateKey]) {
                        eventsByDate[dateKey] = [];
                    }
                    eventsByDate[dateKey].push({...event, id: Object.keys(events)[index]});
                });
                
                // Create calendar view
                let html = '<div class="list-group">';
                
                for (const [date, dateEvents] of Object.entries(eventsByDate)) {
                    html += `
                        <div class="list-group-item bg-light">
                            <h6 class="mb-0">${date}</h6>
                        </div>
                    `;
                    
                    dateEvents.forEach(event => {
                        const startDate = new Date(event.start);
                        const endDate = event.end ? new Date(event.end) : null;
                        
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${event.title}</h5>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-type="events" data-id="${event.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <p class="mb-1">${event.description || 'No description'}</p>
                                <small>
                                    ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    ${endDate ? ` - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : ''}
                                </small>
                                ${event.recurring ? `<span class="badge bg-info ms-1">${event.recurrence_pattern}</span>` : ''}
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading events:', error);
                document.getElementById('calendar-view').innerHTML = '<p class="text-center py-5 text-danger">Error loading events</p>';
            });
    }
    
    // Load tasks
    function loadTasks() {
        fetch('/api/get_tasks')
            .then(response => response.json())
            .then(tasks => {
                const container = document.getElementById('calendar-view');
                
                if (Object.keys(tasks).length === 0) {
                    container.innerHTML = '<p class="text-center py-5">No tasks created</p>';
                    return;
                }
                
                // Sort tasks by due date and priority
                const sortedTasks = Object.values(tasks).sort((a, b) => {
                    // First sort by due date
                    const dateDiff = new Date(a.due_date) - new Date(b.due_date);
                    if (dateDiff !== 0) return dateDiff;
                    
                    // Then sort by priority (high > medium > low)
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });
                
                // Group tasks by status (overdue, today, upcoming)
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const overdueTasks = sortedTasks.filter(task => new Date(task.due_date) < today && !task.completed);
                const todayTasks = sortedTasks.filter(task => {
                    const taskDate = new Date(task.due_date);
                    return taskDate.getFullYear() === today.getFullYear() && 
                           taskDate.getMonth() === today.getMonth() && 
                           taskDate.getDate() === today.getDate() && 
                           !task.completed;
                });
                const upcomingTasks = sortedTasks.filter(task => new Date(task.due_date) > today && !task.completed);
                const completedTasks = sortedTasks.filter(task => task.completed);
                
                let html = '<div class="list-group">';
                
                // Overdue tasks
                if (overdueTasks.length > 0) {
                    html += `
                        <div class="list-group-item bg-danger text-white">
                            <h6 class="mb-0">Overdue</h6>
                        </div>
                    `;
                    
                    overdueTasks.forEach((task, index) => {
                        const taskId = Object.keys(tasks)[index];
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" data-task-id="${taskId}" ${task.completed ? 'checked' : ''}>
                                        <label class="form-check-label ${task.completed ? 'text-decoration-line-through' : ''}" for="task-${taskId}">
                                            <strong>${task.name}</strong>
                                        </label>
                                    </div>
                                    <div>
                                        <span class="badge bg-${task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'secondary'} me-2">
                                            ${task.priority}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-type="tasks" data-id="${taskId}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1 mt-2">${task.description || 'No description'}</p>
                                <small class="text-danger">Due: ${new Date(task.due_date).toLocaleDateString()}</small>
                            </div>
                        `;
                    });
                }
                
                // Today's tasks
                if (todayTasks.length > 0) {
                    html += `
                        <div class="list-group-item bg-warning text-white">
                            <h6 class="mb-0">Today</h6>
                        </div>
                    `;
                    
                    todayTasks.forEach((task, index) => {
                        const taskId = Object.keys(tasks)[index];
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" data-task-id="${taskId}" ${task.completed ? 'checked' : ''}>
                                        <label class="form-check-label ${task.completed ? 'text-decoration-line-through' : ''}" for="task-${taskId}">
                                            <strong>${task.name}</strong>
                                        </label>
                                    </div>
                                    <div>
                                        <span class="badge bg-${task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'secondary'} me-2">
                                            ${task.priority}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-type="tasks" data-id="${taskId}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1 mt-2">${task.description || 'No description'}</p>
                                <small>Due: Today</small>
                            </div>
                        `;
                    });
                }
                
                // Upcoming tasks
                if (upcomingTasks.length > 0) {
                    html += `
                        <div class="list-group-item bg-info text-white">
                            <h6 class="mb-0">Upcoming</h6>
                        </div>
                    `;
                    
                    upcomingTasks.forEach((task, index) => {
                        const taskId = Object.keys(tasks)[index];
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" data-task-id="${taskId}" ${task.completed ? 'checked' : ''}>
                                        <label class="form-check-label ${task.completed ? 'text-decoration-line-through' : ''}" for="task-${taskId}">
                                            <strong>${task.name}</strong>
                                        </label>
                                    </div>
                                    <div>
                                        <span class="badge bg-${task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'secondary'} me-2">
                                            ${task.priority}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-type="tasks" data-id="${taskId}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1 mt-2">${task.description || 'No description'}</p>
                                <small>Due: ${new Date(task.due_date).toLocaleDateString()}</small>
                            </div>
                        `;
                    });
                }
                
                // Completed tasks
                if (completedTasks.length > 0) {
                    html += `
                        <div class="list-group-item bg-success text-white">
                            <h6 class="mb-0">Completed</h6>
                        </div>
                    `;
                    
                    completedTasks.forEach((task, index) => {
                        const taskId = Object.keys(tasks)[index];
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" data-task-id="${taskId}" checked>
                                        <label class="form-check-label text-decoration-line-through" for="task-${taskId}">
                                            <strong>${task.name}</strong>
                                        </label>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-type="tasks" data-id="${taskId}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1 mt-2">${task.description || 'No description'}</p>
                                <small>Completed on ${task.completed_date ? new Date(task.completed_date).toLocaleDateString() : 'Unknown date'}</small>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
                
                // Add event listeners to checkboxes
                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const taskId = this.getAttribute('data-task-id');
                        const completed = this.checked;
                        
                        fetch(`/api/update_task/${taskId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ completed: completed })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                loadTasks(); // Reload tasks to reflect changes
                            } else {
                                console.error('Error updating task:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating task:', error);
                        });
                    });
                });
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                document.getElementById('calendar-view').innerHTML = '<p class="text-center py-5 text-danger">Error loading tasks</p>';
            });
    }
    
    // Delete item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
            deleteItemType = btn.dataset.type;
            deleteItemId = btn.dataset.id;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }
    });
    
    document.getElementById('confirm-delete').addEventListener('click', function() {
        fetch(`/api/delete_item/${deleteItemType}/${deleteItemId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                
                // Reload the current view
                if (currentView === 'events') {
                    loadEvents();
                } else {
                    loadTasks();
                }
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted',
                    text: 'Item has been deleted successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Failed to delete item');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to delete item'
            });
        });
    });
    
    // Initialize with events view
    loadEvents();
    loadUpcomingEvents();  // Add this
    loadUpcomingTasks();   // Add this
});
</script>
{% endblock %}