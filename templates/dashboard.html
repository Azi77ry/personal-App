{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Financial Summary</h5>
                <a href="/money" class="btn btn-sm btn-light">View Details</a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h6>Income</h6>
                        <h4 id="total-income" class="text-success">Tsh0</h4>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6>Expenses</h6>
                        <h4 id="total-expense" class="text-danger">Tsh0</h4>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6>Balance</h6>
                        <h4 id="balance">Tsh0</h4>
                    </div>
                </div>
                <canvas id="financeChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Upcoming Events</h5>
                <a href="/events" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body"> 
                <div id="upcoming-events" class="list-group">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Transactions</h5>
                <div>
                    <a href="/money" class="btn btn-sm btn-light">View All</a>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="transactionsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button">Expenses</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="incomes-tab" data-bs-toggle="tab" data-bs-target="#incomes" type="button">Incomes</button>
                    </li>
                </ul>
                <div class="tab-content" id="transactionsTabContent">
                    <div class="tab-pane fade show active" id="expenses" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="recent-expenses">
                                    <tr>
                                        <td colspan="4" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="incomes" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Source</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="recent-incomes">
                                    <tr>
                                        <td colspan="4" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Savings Goals</h5>
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addGoalModal">Add Goal</button>
            </div>
            <div class="card-body">
                <div id="goals-list">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGoalModalLabel">Add New Savings Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="goal-form">
                    <div class="mb-3">
                        <label for="goal-name" class="form-label">Goal Name</label>
                        <input type="text" class="form-control" id="goal-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="goal-amount" class="form-label">Target Amount</label>
                        <input type="number" step="0.01" class="form-control" id="goal-amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="goal-current" class="form-label">Current Amount</label>
                        <input type="number" step="0.01" class="form-control" id="goal-current" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="goal-date" class="form-label">Target Date (optional)</label>
                        <input type="date" class="form-control" id="goal-date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-goal">Save Goal</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let deleteItemType, deleteItemId;
    
    // Format currency
    function formatCurrency(amount) {
        return 'Tsh' + parseFloat(amount).toFixed(2);
    }
    
    // Load financial summary
    function loadFinancialSummary() {
        fetch('/api/get_financial_summary')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-income').textContent = formatCurrency(data.total_income);
                document.getElementById('total-expense').textContent = formatCurrency(data.total_expense);
                document.getElementById('balance').textContent = formatCurrency(data.balance);
                
                // Create chart
                const ctx = document.getElementById('financeChart').getContext('2d');
                if (window.financeChart) {
                    window.financeChart.destroy();
                }
                window.financeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Income', 'Expenses'],
                        datasets: [{
                            data: [data.total_income, data.total_expense],
                            backgroundColor: ['#4bc0c0', '#ff6384'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading financial summary:', error);
            });
    }
    
    // Load recent expenses
    function loadRecentExpenses() {
        fetch('/api/get_expenses')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('recent-expenses');
                const expenses = Object.values(data).sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at)).slice(0, 5);
                
                if (expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No expenses recorded</td></tr>';
                } else {
                    tbody.innerHTML = expenses.map(expense => `
                        <tr>
                            <td>${new Date(expense.date || expense.created_at).toLocaleDateString()}</td>
                            <td>${expense.category ? expense.category.charAt(0).toUpperCase() + expense.category.slice(1) : 'Uncategorized'}</td>
                            <td class="text-danger">-${formatCurrency(expense.amount)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-type="expenses" data-id="${Object.keys(data).find(key => data[key] === expense)}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Error loading expenses:', error);
                document.getElementById('recent-expenses').innerHTML = '<tr><td colspan="4" class="text-center py-3 text-danger">Error loading expenses</td></tr>';
            });
    }
    
    // Load recent incomes
    function loadRecentIncomes() {
        fetch('/api/get_incomes')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('recent-incomes');
                const incomes = Object.values(data).sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at)).slice(0, 5);
                
                if (incomes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No incomes recorded</td></tr>';
                } else {
                    tbody.innerHTML = incomes.map(income => `
                        <tr>
                            <td>${new Date(income.date || income.created_at).toLocaleDateString()}</td>
                            <td>${income.source || 'Unknown'}</td>
                            <td class="text-success">+${formatCurrency(income.amount)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-type="incomes" data-id="${Object.keys(data).find(key => data[key] === income)}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Error loading incomes:', error);
                document.getElementById('recent-incomes').innerHTML = '<tr><td colspan="4" class="text-center py-3 text-danger">Error loading incomes</td></tr>';
            });
    }
    
    // Load upcoming events
    function loadUpcomingEvents() {
        fetch('/api/get_events')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('upcoming-events');
                const now = new Date();
                const upcomingEvents = Object.values(data)
                    .filter(event => new Date(event.start) >= now)
                    .sort((a, b) => new Date(a.start) - new Date(b.start))
                    .slice(0, 5);
                
                if (upcomingEvents.length === 0) {
                    container.innerHTML = '<div class="list-group-item">No upcoming events</div>';
                } else {
                    container.innerHTML = upcomingEvents.map(event => {
                        const startDate = new Date(event.start);
                        const endDate = new Date(event.end);
                        return `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${event.title}</h6>
                                    <small>${startDate.toLocaleDateString()}</small>
                                </div>
                                <p class="mb-1 small">${event.description || 'No description'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-type="events" data-id="${Object.keys(data).find(key => data[key] === event)}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            })
            .catch(error => {
                console.error('Error loading events:', error);
                document.getElementById('upcoming-events').innerHTML = '<div class="list-group-item text-danger">Error loading events</div>';
            });
    }
    
    // Load goals
    function loadGoals() {
        fetch('/api/get_goals')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('goals-list');
                const goals = Object.values(data);
                
                if (goals.length === 0) {
                    container.innerHTML = '<p class="text-center py-3">No goals set</p>';
                } else {
                    container.innerHTML = goals.map(goal => {
                        const progress = (goal.current_amount / goal.target_amount) * 100;
                        return `
                            <div class="mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${goal.name}</h6>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-type="goals" data-id="${Object.keys(data).find(key => data[key] === goal)}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>${formatCurrency(goal.current_amount)}</span>
                                    <span>${formatCurrency(goal.target_amount)}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: ${Math.min(progress, 100)}%" 
                                        aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                ${goal.target_date ? `<small class="text-muted">Target: ${new Date(goal.target_date).toLocaleDateString()}</small>` : ''}
                            </div>
                        `;
                    }).join('');
                }
            })
            .catch(error => {
                console.error('Error loading goals:', error);
                container.innerHTML = '<p class="text-center py-3 text-danger">Error loading goals</p>';
            });
    }
    
    // Add goal functionality
    document.getElementById('save-goal').addEventListener('click', function() {
        const name = document.getElementById('goal-name').value;
        const amount = parseFloat(document.getElementById('goal-amount').value);
        const current = parseFloat(document.getElementById('goal-current').value) || 0;
        const date = document.getElementById('goal-date').value;
        
        if (name && amount) {
            const goalData = {
                name: name,
                target_amount: amount,
                current_amount: current,
                target_date: date || null
            };
            
            fetch('/api/add_goal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goalData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Close modal and reset form
                    bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
                    document.getElementById('goal-form').reset();
                    
                    // Reload goals
                    loadGoals();
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Goal Added',
                        text: 'Your savings goal has been added successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(data.message || 'Failed to add goal');
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to add goal'
                });
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Please provide a name and target amount for your goal'
            });
        }
    });
    
    // Delete item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
            deleteItemType = btn.dataset.type;
            deleteItemId = btn.dataset.id;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }
    });
    
    document.getElementById('confirm-delete').addEventListener('click', function() {
        fetch(`/api/delete_item/${deleteItemType}/${deleteItemId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                
                // Reload the appropriate section
                switch(deleteItemType) {
                    case 'expenses':
                        loadRecentExpenses();
                        loadFinancialSummary();
                        break;
                    case 'incomes':
                        loadRecentIncomes();
                        loadFinancialSummary();
                        break;
                    case 'events':
                        loadUpcomingEvents();
                        break;
                    case 'goals':
                        loadGoals();
                        break;
                }
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted',
                    text: 'Item has been deleted successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Failed to delete item');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to delete item'
            });
        });
    });
    
    // Initialize all data
    loadFinancialSummary();
    loadRecentExpenses();
    loadRecentIncomes();
    loadUpcomingEvents();
    loadGoals();
});
</script>
{% endblock %}