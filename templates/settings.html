{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>User Profile</h5>
            </div>
            <div class="card-body">
                <form id="profile-form">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="user-username" value="{{ current_user.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="user-email" value="{{ current_user.email }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="user-currency">
                            <option value="USD">US Dollar ($)</option>
                            <option value="Tsh">Tanzania Shillings (Tsh)</option>
                            <option value="GBP">British Pound (£)</option>
                            <option value="JPY">Japanese Yen (¥)</option>
                            <option value="INR">Indian Rupee (₹)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5>Notification Settings</h5>
            </div>
            <div class="card-body">
                <form id="notification-form">
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="email-notifications" checked>
                        <label class="form-check-label" for="email-notifications">Email Notifications</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bill-reminders" checked>
                        <label class="form-check-label" for="bill-reminders">Bill Reminders</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="event-reminders" checked>
                        <label class="form-check-label" for="event-reminders">Event Reminders</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Time</label>
                        <input type="time" class="form-control" id="notification-time" value="09:00">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5>Change Password</h5>
            </div>
            <div class="card-body">
                <form id="password-form">
                    <div class="mb-3">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5>Data Management</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="export-data">
                        <i class="bi bi-download me-2"></i>Export All Data
                    </button>
                    <button class="btn btn-outline-secondary" id="import-data">
                        <i class="bi bi-upload me-2"></i>Import Data
                    </button>
                    <button class="btn btn-outline-danger" id="reset-data">
                        <i class="bi bi-trash me-2"></i>Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Data Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="import-file" class="form-label">Select JSON file to import</label>
                    <input class="form-control" type="file" id="import-file" accept=".json">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="import-overwrite">
                    <label class="form-check-label" for="import-overwrite">
                        Overwrite existing data
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-import">Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile form submission
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const profileData = {
            username: document.getElementById('user-username').value,
            email: document.getElementById('user-email').value,
            currency: document.getElementById('user-currency').value
        };
        
        // In a real app, you would send this to the server
        Swal.fire({
            icon: 'success',
            title: 'Profile Updated',
            text: 'Your profile information has been updated successfully!',
            timer: 2000,
            showConfirmButton: false
        });
    });
    
    // Notification form submission
    document.getElementById('notification-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const notificationData = {
            email: document.getElementById('email-notifications').checked,
            bills: document.getElementById('bill-reminders').checked,
            events: document.getElementById('event-reminders').checked,
            time: document.getElementById('notification-time').value
        };
        
        // In a real app, you would send this to the server
        Swal.fire({
            icon: 'success',
            title: 'Settings Saved',
            text: 'Your notification settings have been saved!',
            timer: 2000,
            showConfirmButton: false
        });
    });
    
    // Password form submission
    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPass = document.getElementById('current-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmPass = document.getElementById('confirm-password').value;
        
        if (newPass !== confirmPass) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Passwords do not match!'
            });
            return;
        }
        
        if (newPass.length < 8) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Password must be at least 8 characters long!'
            });
            return;
        }
        
        // In a real app, you would verify current password and update via API
        Swal.fire({
            icon: 'success',
            title: 'Password Changed',
            text: 'Your password has been changed successfully!',
            timer: 2000,
            showConfirmButton: false
        });
        
        document.getElementById('password-form').reset();
    });
    
    // Export data
    document.getElementById('export-data').addEventListener('click', function() {
        // In a real app, you would fetch all data from the server
        Promise.all([
            fetch('/api/get_expenses').then(res => res.json()),
            fetch('/api/get_incomes').then(res => res.json()),
            fetch('/api/get_events').then(res => res.json()),
            fetch('/api/get_budgets').then(res => res.json()),
            fetch('/api/get_goals').then(res => res.json()),
            fetch('/api/get_tasks').then(res => res.json()),
            fetch('/api/get_bills').then(res => res.json())
        ]).then(([expenses, incomes, events, budgets, goals, tasks, bills]) => {
            const data = {
                expenses: expenses,
                incomes: incomes,
                events: events,
                budgets: budgets,
                goals: goals,
                tasks: tasks,
                bills: bills
            };
            
            // Create download link
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const dataUrl = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `money_event_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            Swal.fire({
                icon: 'success',
                title: 'Export Complete',
                text: 'Your data has been exported successfully!',
                timer: 2000,
                showConfirmButton: false
            });
        })
        .catch(error => {
            console.error('Error exporting data:', error);
            Swal.fire({
                icon: 'error',
                title: 'Export Failed',
                text: 'There was an error exporting your data.'
            });
        });
    });
    
    // Import data
    document.getElementById('import-data').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('importModal'));
        modal.show();
    });
    
    document.getElementById('confirm-import').addEventListener('click', function() {
        const fileInput = document.getElementById('import-file');
        const overwrite = document.getElementById('import-overwrite').checked;
        
        if (fileInput.files.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'No File Selected',
                text: 'Please select a file to import.'
            });
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // In a real app, you would send this to the server
                console.log('Importing data:', data);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Import Complete',
                    text: 'Your data has been imported successfully!',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            } catch (error) {
                console.error('Error parsing JSON:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File',
                    text: 'The selected file is not valid JSON.'
                });
            }
        };
        
        reader.onerror = function() {
            Swal.fire({
                icon: 'error',
                title: 'File Error',
                text: 'There was an error reading the file.'
            });
        };
        
        reader.readAsText(file);
    });
    
    // Reset data
    document.getElementById('reset-data').addEventListener('click', function() {
        Swal.fire({
            icon: 'warning',
            title: 'Reset All Data?',
            text: 'This will permanently delete all your data and cannot be undone!',
            showCancelButton: true,
            confirmButtonText: 'Yes, reset all data',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#dc3545'
        }).then((result) => {
            if (result.isConfirmed) {
                // In a real app, you would call an API to reset data
                fetch('/api/reset_data', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Data Reset',
                            text: 'All data has been reset successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        throw new Error(data.message || 'Failed to reset data');
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to reset data'
                    });
                });
            }
        });
    });
});
</script>
{% endblock %}